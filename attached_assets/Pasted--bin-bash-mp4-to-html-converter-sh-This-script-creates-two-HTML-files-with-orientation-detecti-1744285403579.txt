#!/bin/bash
# mp4-to-html-converter.sh
# This script creates two HTML files with orientation detection:
# 1) HTML for videos 1 (portrait) and 2 (landscape)
# 2) HTML for videos 3 (portrait) and 4 (landscape)

# Directory where MP4 files are located (current directory)
VIDEO_DIR="."

# Create HTML with two embedded videos (portrait and landscape)
create_dual_orientation_html() {
    local portrait_file="$1"
    local landscape_file="$2"
    local html_filename="$3"
    
    echo "Creating ${html_filename} with portrait (${portrait_file}) and landscape (${landscape_file})..."
    
    # Check if files exist
    if [ ! -f "$portrait_file" ]; then
        echo "Error: Portrait file $portrait_file not found!"
        return 1
    fi
    
    if [ ! -f "$landscape_file" ]; then
        echo "Error: Landscape file $landscape_file not found!"
        return 1
    fi
    
    # Get base64 encoded videos
    echo "Encoding portrait video to base64 (this may take a moment)..."
    portrait_base64=$(base64 -i "$portrait_file")
    
    if [ $? -ne 0 ]; then
        echo "Error encoding portrait video to base64!"
        return 1
    fi
    
    echo "Encoding landscape video to base64 (this may take a moment)..."
    landscape_base64=$(base64 -i "$landscape_file")
    
    if [ $? -ne 0 ]; then
        echo "Error encoding landscape video to base64!"
        return 1
    fi
    
    # Create the HTML file with embedded videos and orientation detection
    cat > "$html_filename" << EOL
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="ad.size" content="width=320,height=480">
    <title>Video Ad with Orientation Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
            background-color: #000;
            position: fixed;
        }
        #videoContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        video {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none; /* Initially hidden until proper orientation detected */
        }
        #portraitVideo {
            display: none;
        }
        #landscapeVideo {
            display: none;
        }
        #fallbackImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            background-color: #000;
        }
        #closeButton {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            text-decoration: none;
            z-index: 3;
        }
        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            text-align: center;
            z-index: 1;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loadingIndicator">
        <div class="spinner"></div>
        Loading...
    </div>
    
    <div id="videoContainer">
        <!-- Portrait Video -->
        <video id="portraitVideo" playsinline webkit-playsinline muted preload="auto" loop>
            <source src="data:video/mp4;base64,${portrait_base64}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <!-- Landscape Video -->
        <video id="landscapeVideo" playsinline webkit-playsinline muted preload="auto" loop>
            <source src="data:video/mp4;base64,${landscape_base64}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <img id="fallbackImage" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Fallback">
    </div>
    
    <a id="closeButton" href="javascript:void(0);">Ã—</a>

    <script>
        // AppLovin/MRAID integration with orientation detection
        (function() {
            var portraitVideo = document.getElementById('portraitVideo');
            var landscapeVideo = document.getElementById('landscapeVideo');
            var fallbackImage = document.getElementById('fallbackImage');
            var videoContainer = document.getElementById('videoContainer');
            var closeButton = document.getElementById('closeButton');
            var loadingIndicator = document.getElementById('loadingIndicator');
            var activeVideo = null;
            var isLandscape = false;
            var videoLoaded = false;
            var videoAttempted = false;
            
            // Hide loading indicator
            function hideLoading() {
                loadingIndicator.style.display = 'none';
            }
            
            // Check device orientation and show appropriate video
            function checkOrientation() {
                // Use window dimensions to determine orientation
                // width > height = landscape, otherwise portrait
                var newIsLandscape = window.innerWidth > window.innerHeight;
                
                // Only switch if orientation changed
                if (newIsLandscape !== isLandscape || !activeVideo) {
                    isLandscape = newIsLandscape;
                    
                    if (isLandscape) {
                        console.log('Landscape orientation detected');
                        if (activeVideo !== landscapeVideo) {
                            // Switch to landscape video
                            if (activeVideo) activeVideo.pause();
                            portraitVideo.style.display = 'none';
                            landscapeVideo.style.display = 'block';
                            activeVideo = landscapeVideo;
                            tryPlayVideo();
                        }
                    } else {
                        console.log('Portrait orientation detected');
                        if (activeVideo !== portraitVideo) {
                            // Switch to portrait video
                            if (activeVideo) activeVideo.pause();
                            landscapeVideo.style.display = 'none';
                            portraitVideo.style.display = 'block';
                            activeVideo = portraitVideo;
                            tryPlayVideo();
                        }
                    }
                }
            }
            
            // Try to play the current active video
            function tryPlayVideo() {
                if (!activeVideo) return;
                
                // Force unmute for better autoplay success
                activeVideo.muted = true;
                
                var playPromise = activeVideo.play();
                if (playPromise !== undefined) {
                    playPromise.catch(function(error) {
                        console.error('Autoplay failed:', error);
                        
                        // Add user interaction to trigger play
                        document.body.addEventListener('click', function bodyClick() {
                            activeVideo.play().catch(function(err) {
                                console.error('Play after click failed:', err);
                            });
                            document.body.removeEventListener('click', bodyClick);
                        }, { once: true });
                    });
                }
            }
            
            // Check for both AppLovin and MRAID
            function checkMRAID() {
                if (typeof mraid !== 'undefined') {
                    console.log('MRAID found');
                    initMRAID();
                } else if (typeof AppLovinAds !== 'undefined') {
                    console.log('AppLovinAds found');
                    initAppLovin();
                } else {
                    // Poll for either API
                    var apiCheck = setInterval(function() {
                        if (typeof mraid !== 'undefined') {
                            clearInterval(apiCheck);
                            console.log('MRAID found (delayed)');
                            initMRAID();
                        } else if (typeof AppLovinAds !== 'undefined') {
                            clearInterval(apiCheck);
                            console.log('AppLovinAds found (delayed)');
                            initAppLovin();
                        }
                    }, 100);
                    
                    // Time out after 2 seconds
                    setTimeout(function() {
                        clearInterval(apiCheck);
                        console.log('No ad SDKs found, continuing in test mode');
                        setupFallbackHandlers();
                    }, 2000);
                }
                
                // Setup orientation detection
                checkOrientation();
                window.addEventListener('resize', checkOrientation);
                
                // Make sure videos are loaded
                preloadVideos();
            }
            
            // Preload both videos
            function preloadVideos() {
                videoAttempted = true;
                
                // Show loading while waiting for videos
                loadingIndicator.style.display = 'block';
                
                // Count loaded videos
                var loadedCount = 0;
                function videoLoaded() {
                    loadedCount++;
                    if (loadedCount >= 2) {
                        // Both videos loaded
                        hideLoading();
                        videoLoaded = true;
                        checkOrientation(); // Start playing appropriate video
                    }
                }
                
                // Check if videos are loaded
                portraitVideo.addEventListener('loadeddata', videoLoaded);
                landscapeVideo.addEventListener('loadeddata', videoLoaded);
                
                // Set a timeout in case videos don't load
                setTimeout(function() {
                    if (!videoLoaded) {
                        console.warn('Videos taking too long to load, showing fallback');
                        showFallback();
                    }
                }, 5000);
                
                // Handle video load errors
                portraitVideo.addEventListener('error', function(e) {
                    console.error('Portrait video error:', e);
                    showFallback();
                });
                
                landscapeVideo.addEventListener('error', function(e) {
                    console.error('Landscape video error:', e);
                    showFallback();
                });
                
                // Force load videos
                portraitVideo.load();
                landscapeVideo.load();
            }
            
            // Initialize MRAID
            function initMRAID() {
                // Wait for MRAID ready event
                if (mraid.getState() === 'ready') {
                    mraidSetup();
                } else {
                    mraid.addEventListener('ready', mraidSetup);
                }
            }
            
            // Initialize AppLovin SDK
            function initAppLovin() {
                videoContainer.addEventListener('click', function() {
                    handleAdClick();
                });
                
                closeButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (typeof AppLovinAds !== 'undefined' && AppLovinAds.close) {
                        AppLovinAds.close();
                    }
                });
            }
            
            // MRAID setup after ready
            function mraidSetup() {
                videoContainer.addEventListener('click', function() {
                    handleAdClick();
                });
                
                closeButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (mraid && mraid.close) {
                        mraid.close();
                    }
                });
                
                // Ensure ad is visible
                if (mraid.isViewable()) {
                    onViewable();
                } else {
                    mraid.addEventListener('viewableChange', function(viewable) {
                        if (viewable) {
                            onViewable();
                        } else {
                            // Pause videos if not viewable
                            portraitVideo.pause();
                            landscapeVideo.pause();
                        }
                    });
                }
            }
            
            // Handle when ad becomes viewable
            function onViewable() {
                // Videos should already be loaded, just make sure active one is playing
                if (activeVideo) {
                    tryPlayVideo();
                }
            }
            
            function showFallback() {
                // Hide loading and videos, show fallback image
                hideLoading();
                portraitVideo.style.display = 'none';
                landscapeVideo.style.display = 'none';
                fallbackImage.style.display = 'block';
            }
            
            // Handle ad click
            function handleAdClick() {
                console.log('Ad clicked');
                
                // Track click via proper SDK
                if (typeof mraid !== 'undefined' && mraid.open) {
                    mraid.open('https://play.google.com/store/apps');
                } else if (typeof AppLovinAds !== 'undefined' && AppLovinAds.click) {
                    AppLovinAds.click();
                } else {
                    // Fallback for testing
                    console.log('Test mode: Opening app store URL');
                    window.open('https://play.google.com/store/apps', '_blank');
                }
            }
            
            // Fallback handlers for testing environments
            function setupFallbackHandlers() {
                console.log('Setting up fallback/test mode handlers');
                
                videoContainer.addEventListener('click', function() {
                    handleAdClick();
                });
                
                closeButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Close button clicked (test mode)');
                    alert('In production, this would close the ad');
                });
            }
            
            // Add immediate play attempts on user interaction for iOS
            document.addEventListener('touchstart', function() {
                if (activeVideo) {
                    activeVideo.play().catch(function(e) {
                        console.log('Play on touch failed:', e);
                    });
                }
            }, {once: true});
            
            // Start initialization
            document.addEventListener('DOMContentLoaded', function() {
                checkMRAID();
            });
            
            // Backup start - sometimes DOMContentLoaded doesn't fire in ad environments
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                setTimeout(function() {
                    if (!videoAttempted) {
                        checkMRAID();
                    }
                }, 100);
            }
        })();
    </script>
</body>
</html>
EOL

    echo "Created ${html_filename} with orientation detection."
    return 0
}

# Create HTML files
echo "Creating HTML files with orientation detection..."

# Check if files exist
FIRST_HTML="ad1.html"
SECOND_HTML="ad2.html"

# Files for first ad (videos 1 and 2)
PORTRAIT1=""
LANDSCAPE1=""

if [ -f "1" ]; then
    PORTRAIT1="1"
elif [ -f "1.mp4" ]; then
    PORTRAIT1="1.mp4"
else
    echo "Warning: Portrait video file 1 not found!"
fi

if [ -f "2" ]; then
    LANDSCAPE1="2"
elif [ -f "2.mp4" ]; then
    LANDSCAPE1="2.mp4"
else
    echo "Warning: Landscape video file 2 not found!"
fi

# Files for second ad (videos 3 and 4)
PORTRAIT2=""
LANDSCAPE2=""

if [ -f "3" ]; then
    PORTRAIT2="3"
elif [ -f "3.mp4" ]; then
    PORTRAIT2="3.mp4"
else
    echo "Warning: Portrait video file 3 not found!"
fi

if [ -f "4" ]; then
    LANDSCAPE2="4"
elif [ -f "4.mp4" ]; then
    LANDSCAPE2="4.mp4"
else
    echo "Warning: Landscape video file 4 not found!"
fi

# Create HTML files if both portrait and landscape videos are available
if [ -n "$PORTRAIT1" ] && [ -n "$LANDSCAPE1" ]; then
    create_dual_orientation_html "$PORTRAIT1" "$LANDSCAPE1" "$FIRST_HTML"
else
    echo "Error: Missing videos for first ad (videos 1 and 2)."
fi

if [ -n "$PORTRAIT2" ] && [ -n "$LANDSCAPE2" ]; then
    create_dual_orientation_html "$PORTRAIT2" "$LANDSCAPE2" "$SECOND_HTML"
else
    echo "Error: Missing videos for second ad (videos 3 and 4)."
fi

# Create index.html
if [ -f "$FIRST_HTML" ]; then
    echo "Creating index.html pointing to ${FIRST_HTML}..."
    cat > "index.html" << EOL
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="refresh" content="0;url=${FIRST_HTML}">
    <title>Redirecting to Ad</title>
</head>
<body>
    Redirecting to <a href="${FIRST_HTML}">${FIRST_HTML}</a>...
</body>
</html>
EOL
    echo "Done! Created HTML files with orientation detection."
    echo "To use with AppLovin, simply upload the HTML files."
else
    echo "No HTML files were successfully created."
    exit 1
fi